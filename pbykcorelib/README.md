# pbykcorelib

The `pbykcorelib` library provides low-level, device-agnostic support for the protocol required to enroll YubiKeys and
TPM-based virtual smart card (VSCs) with a Purebred instance. This library does not directly interact with YubiKeys or
VSCs. See [pbyklib](../pbyklib/index.html) for YubiKey and VSC support. Purebred is a derived credential issuance system
used by the U.S. Department of Defense. 

As with all Purebred apps and libraries, enrollment requires the participation of a Purebred Agent. Specifically, when enrolling
a device, you will need a Purebred Agent's EDIPI and a pair of one-time password (OTP) values generated by that agent and
provided in a timely manner. When provisioning user certificates to the device, user key management (UKM) OTPs are required. 
These can be obtained by authenticating to the target Purebred instance using the (simulated) CAC credentials from which 
derived credentials will be created.

The [pbyk](../pbyk/index.html) utility provides sample usage of the `pbyklib` crate.

## Protocol

The protocol is essentially Apple's [Over-the-Air Profile Delivery and Configuration (OTA protocol)](https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/OTASecurity/OTASecurity.html)
with the following three alterations:

- An additional round-trip is added before the OTA protocol is executed to provide the portal with a self-signed certificate corresponding to a freshly generated key pair. This additional step is referred to as Pre-enrollment or Phase 0 and is used to establish trust in a public key associated with the device.
- The Phase 2 response during OTA execution is encrypted using the certificate presented to the portal and verified by a Purebred Agent during Pre-enrollment.
- One or more user key management (UKM) or recover steps may be performed to deliver encrypted configuration protocols following execution of the OTA protocol.

## Features

As with other Purebred apps, information is incorporated into the app for a target environment, i.e., NIPR, SIPR, NIPR test, SIPR test, development.
Unlike other apps, a single `pbyk` build can target multiple environments. Target environments are represented as features
when `pbyk` is built. The following environment-related features are available:

| Feature | Description                 |
|---------|-----------------------------|
| dev     | Development environment     |
| om_nipr | Test environment for NIPR   |
| nipr    | NIPR production environment |
| om_sipr | Test environment for SIPR   |
| sipr    | SIPR production environment |

The `dev` feature is the default. At least one environment-related feature must be elected when `pbyk` is built, else compilation fails.
Features are additive. For example, either of the following commands can be used to build a `pbyk` app that targets dev, om_sipr and sipr.
```bash
cargo build --features om_sipr,sipr --release
cargo build --no-default-features --features dev,om_sipr,sipr --release
```
When more than one environment is available, the `environment` option must be specified. The `help` text for `environment` indicates available options, for example:
```text
  -e, --environment <ENVIRONMENT>  Environment to target [possible values: dev, om-sipr, sipr]
```

## Minimum Supported Rust Version

This crate requires **Rust 1.88.0** at a minimum.

## License

Licensed under either of:

- [Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0)
- [MIT license](http://opensource.org/licenses/MIT)

at your option.

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall be
dual licensed as above, without any additional terms or conditions.
