use yubikey::MgmKey;

use aes::cipher::generic_array::GenericArray;
use cipher::{BlockDecryptMut, KeyIvInit};
use cms::{
    builder::{SignedDataBuilder, SignerInfoBuilder},
    content_info::ContentInfo,
    enveloped_data::{EnvelopedData, RecipientInfo},
    signed_data::{EncapsulatedContentInfo, SignedData, SignerIdentifier},
};
use der::{asn1::OctetString, Any, Decode, Encode, Tag};
use hex_literal::hex;
use pbyklib::data::Phase2Request;
use pbyklib::list_yubikeys::get_yubikey;
use pbyklib::utils::get_ca_cert;
use pbyklib::utils::{buffer_to_hex, verify_and_decrypt};
use pbyklib::utils::{decrypt_inner, process_payloads};
use sha1::Sha1;
use sha2::{Digest, Sha256};
use std::io::Cursor;
use x509_cert::{ext::pkix::SubjectKeyIdentifier, spki::AlgorithmIdentifierOwned};
use yubikey::Serial;
use yubikey::{
    piv,
    piv::{AlgorithmId, SlotId},
    Key, YubiKeySigningKey,
};

#[test]
fn ed_test() {
    let mut yubikey = match get_yubikey(Some(Serial(15995762))) {
        Ok(yk) => yk,
        Err(e) => {
            println!("ERROR: {:?}", e);
            return;
        }
    };
    if yubikey.authenticate(MgmKey::default()).is_err() {
        //todo reset if not the expect value (i.e., not actually default)
    }

    let p2resp = hex!("308214F006092A864886F70D010702A08214E1308214DD020103310D300B060960864801650304020130820E9D06092A864886F70D010701A0820E8E04820E8A3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C646963743E0A093C6B65793E456E637279707465645061796C6F6164436F6E74656E743C2F6B65793E0A093C646174613E0A094D4949495441594A4B6F5A496876634E415163446F4949495054434343446B4341514978676745774D4949424C414942416F41556E6F6C57634D2F414F583356735833420A095671472B584A3861726A41774451594A4B6F5A496876634E41514542425141456767454173416B57714351584F35697249774B6D64414674747239543757734B4A7450330A09537831624F6B426145382B59663549306A36744E54744E424830574A56386F726E336F544259636F746D664F547163346566727254476636617A44394457636B566E7A790A093552454856666274734F6A794C62754A6B7A67704674424276526D536C6D51544279527262415A7651584262634A4557664245476574785A44322B49365A33386D4276320A09426A677476446E6355644E4F6D6471797A314E454C52564F5645554C62594A2B58774D6366706D367A757877414F77503768436D7A2B7179677639524D6A4C6D514A4E760A09366166574943494C336A666F66484A4F4A3839614951756F6344362F6C70706953456675514B4C57574F4A41446173432B4562494D4156716C5769656B535758637654300A0971666C79737A2F65646261644E505167304966617A736A562B502B626141723749685253666A4343427634474353714753496233445145484154416442676C67686B67420A095A514D4541536F454545442B49486B58654A64534C724241716F654B34676541676762516775737050304931336F2F4B79593145374B33665335666E734E37374E3952730A096B313034796D61534B54664E767A49716C454248575770507A64316B76307773486F6E765438734767695867446449526D4D6B437A344E494342474254326D614A416D6F0A0946704C613954526E77756D656F747446695035345342365261306B51694E305676323448534A7071306B4E71634A4A314E753250736B746A5241395543707A7345504E6E0A09326141544534454A7562306E44366C55566539456D705576714378396E2F43734C6467744B6739626E353277474C49362B7943447842354B72566A564F47354D7876426C0A0943664179724F4A7134495965734739576C514E784C42642F753975655A477761766C656F7749594F67326149714F6E424E56394A3246536B63586D764255556D41674B750A096B576C504441652F6B65554C535576526134643370743057787634434E58696B46317450446A52444F73596A38646F38464E5A784A596634386D324B574F577A71654C420A096C3054455A354631744773696B4B364E38643078596C4730384C6C66552F65726C4552464A725249322B752B39596D447648394F3774633233766956697541657A324B780A096B736F634D4E7738696A4457672B4C774E467644446D667A354E445446496A2F414665726C43344D32417959366B505944444D4861614A45514230496A796C664E6D4E570A09744B4654376B5336614B507851396B6E424734554D6A777944756639764843476458557371424770354C54664F6736775045574C50317A61526D75657A506A66595459540A094B38656C67726830767259616A50325A504D306C746D5443683437416236583041593573734134656C4669507630475754336E7946566A32396954554A7767413466644F0A092F574746562B43445A532B634779326437746456776C5371452F4768556D384E332F5975397A2F31566A7242372F4D796346436B474631536D456B3877536B79515831340A094A59535277784E574444764674687A376271644B32756954564F437A496B46754D536D346C474C533445586771342F596533306762344935586B6A42442F48755A716B2B0A0942576E36754B776A35643958664234374573626F496C72526D4A5046785945555035366E34786F486F773861577A5667327076385466325474634F786D6B6A44312B2B4F0A097878512B71626D4F38555171494655502B3574426F4D2B732F6D5A634C7250694564596854427A43556456636C7072762B5277584B355A4C6F424B537946784634694F640A094C4642352B75704D5036713855453554466436504C566D4F7A4C464467493256494C4A4A36444C5845635A4A4C4A775A3265504A68304630305664705255586C707275720A0930636157595175303237346543636D724346774646393551596B5A434E30616D4670514366564771775A3969307565502B326D6C7861696D716151416A42412F766565360A0956784F597347776C514D722B44696C79334276724265706D2B6E6871443459796C48634C32317263442B524434314278465433345073764F327A426F6A49317A2F5378730A09626D575649746679772F347358625674514B544C61457732696141754F5961693669635144637669426A4F2B39474C556B77786A4F4D612B393059466A7959494E3577660A092B446B4B412B49397674346951327A4E6D505270375A4256634B69397556394D6147306A51736F31355A396D675956786B2F516E656E4550504A4B486C6D6662655372520A0955316F4D666C6361644A56672B70742F553562512B684964426945633139613543304670342F7238673239316B31346F676935434B445A617143745354753256746A524D0A0942776C5759366C4A427142576A496C4B344644716159492F52356777504872703252534D7972734330446550572F6E627742645447414671527468642F304358384263750A097032364B54385553346D365767665532446A6977433077385866464C3455445031565652514E6939773167736643334631656A5570333072534F3231424F33354765396E0A0963726955537341754B6634333949744831696B70704A792F37314F47463343732F3338362F574E36437A3533343364506946346E634F4269694A3539456F727A497741490A094F4A54626C506D36545462726D2B3073543172686541345655684D466B50596F41415A772B5963784E334E4E6D36596B514D4D776A627A417237796A49776648783451360A0966414B79332F50556B6D4842746751706845323166566956494E3551484B432B5867692B3139656C54392B7A334F564D62474B7779427A30734A34442F454F335838494C0A095145795976316174766F61474B496271396C79736275766770676C546A3455687848775557392F632B484F76306463552B56785A49712B4B794D33584C735936332F77550A096561387864533655515A6330666F31375736534A78556379535351396863524E46534A56356F5954724A59676976446D74374A4C324337374679573648374975543279390A09627A365677396454327A774D35794C636177315830426F32494B577A7865483652536E70524A7A364A68525273707A6D635353716F764F674C3050636231433348544E6F0A092B6838622F62634F683857496A5570645372796757544731316C313446594B334D5856714671456C6573534B5175366C54737139626B7170385670736C594257376664670A0967667361387550392B6D725941424A4731366F4F75537A43743267412B5575516D745A76624F715849796D526B3248783136744337614941506B316C467149526D324F790A0976454D2F32335673534C73564476396B6678374F50664F354D766750552B77476B3733566679514A516364474E36344F62784C713030704668554F73395A447137436D5A0A0930787832716B797652786B4E4D472F346B665950797779334A4538745535344C6B4D7248424630784F72487735747657366333557477327842584C3570466F756B7866380A09736D756F393654424D364E3755654F54644570646A4B30525249496B646C474D704E3274655171356D2F4E47507A5234784D39736E6A6F4746616956765946374955594E0A09574C48537355313934763555493850474E59747938466B4F79546333644D6564586C71422B6F55416364667A5838634C3053624F4734426F767163337165594D4F5075790A0934426133574A676666334C784C39732F6E3578647469734E397251336B384C4B4E4A752F65775031685173313738544F50513D3D0A093C2F646174613E0A093C6B65793E5061796C6F61644465736372697074696F6E3C2F6B65793E0A093C737472696E673E5068617365203220636F6E66696775726174696F6E2070726F66696C653C2F737472696E673E0A093C6B65793E5061796C6F6164446973706C61794E616D653C2F6B65793E0A093C737472696E673E507572656272656420436F6E66696775726174696F6E202870686173652032293C2F737472696E673E0A093C6B65793E5061796C6F61644964656E7469666965723C2F6B65793E0A093C737472696E673E7265642E686F756E642E70726F66696C652D736572766963652E30393030653064302D316135342D313165652D623766372D3065336562366136613564643C2F737472696E673E0A093C6B65793E5061796C6F61644F7267616E697A6174696F6E3C2F6B65793E0A093C737472696E673E446F443C2F737472696E673E0A093C6B65793E5061796C6F616452656D6F76616C446973616C6C6F7765643C2F6B65793E0A093C66616C73652F3E0A093C6B65793E5061796C6F6164547970653C2F6B65793E0A093C737472696E673E436F6E66696775726174696F6E3C2F737472696E673E0A093C6B65793E5061796C6F6164555549443C2F6B65793E0A093C737472696E673E30393030653064302D316135342D313165652D623766372D3065336562366136613564643C2F737472696E673E0A093C6B65793E5061796C6F616456657273696F6E3C2F6B65793E0A093C696E74656765723E313C2F696E74656765723E0A3C2F646963743E0A3C2F706C6973743E0AA082049A308204963082037EA00302010202025EED300D06092A864886F70D01010B0500305D310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03446F44310C300A060355040B0C03504B493118301606035504030C0F444F442050422053572043412D3533301E170D3232303531393136353331365A170D3235303430383130353130345A3057310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03504B493120301E06035504030C175075726562726564205061796C6F6164205369676E657230820122300D06092A864886F70D01010105000382010F003082010A0282010100BD9E57FAEA20C4C4AF323D8D5ED46FF71BB0F6E705A037CC425D33BE74F7CE06981C65975F8A4663BDF5F177B754DFBD17D386324189B8F62EB2FA361BA7ABF5F307CB5E69E81948C88E86E0642352E0033D61E3EDE4412BF870392E5CA85D894ED7748E687E1B4443E08AC06AA73513D4E5D4C99843873F470B143A302F1B3DEC04E8F63D988AEE170C16826129E94F000A816C541AD67615686198918197EF23A50C2B14DB04E2E175AE4D9440C9E6DCE9287514DE4CC09B6139779E0D12E07575C4A72D311487241E2D1E520B5CAA1E1F668B0A211114485744BD12027B92DFF3320ABFF7560C11D70C8C3C87DDB6D88D315C0656EBCE8EF06AA3F275CCE30203010001A382016430820160301F0603551D2304183016801461BF1745A00B56DC28F3EEC5FB6DA305C3B5F48C301D0603551D0E04160414D8D53B10803CBE8B58533012B4AA4D00F901D30F30818306082B0601050507010104773075304306082B060105050730028637687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F7369676E2F444F445042535743415F35332E636572302E06082B060105050730018622687474703A2F2F70626F6373702E726564686F756E64736F6674776172652E6E6574300E0603551D0F0101FF0404030205A030470603551D1F0440303E303CA03AA0388636687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F63726C2F444F445042535743415F35332E63726C30160603551D20040F300D300B0609608648016502010B2730270603551D250420301E06082B0601050507030106082B0601050507030206082B06010505080202300D06092A864886F70D01010B05000382010100926B181913EB28DE70DEC9D07DC782114A78513E820A575C64321039616C83BB4ED7E0C7B53F641E335A3F1191013F3B5222C127C59AD8E32A8E5E1D58BE8DA1895C2FDF480490646D604209A99898E3D469C9DE37746750DFB20AE22A68998064E630BFB1562132667FFB4C40D3A700757AA139A40243658F3FC5A12ECE9D9BDBE0F1B0B6D6A30FD0230DE69F4321E6AE9A3EE339622312EB8D1526D294F9D70E08B99E2E009D7D95923AC20226B322EFB3736AFB08D9D96E6A6C5BD7ACED8947EAC1AA29B79B7443F1F55C69C844CED9182762AFE749B9A21B78D3BDB98C3624021B459901FAA988AF910312F8AC65FDF720EF1125F1A8C2B7EE21EE3AF95731820188308201840201038014D8D53B10803CBE8B58533012B4AA4D00F901D30F300B0609608648016503040201A04B301806092A864886F70D010903310B06092A864886F70D010701302F06092A864886F70D010904312204207F1A4279FE4716213F85F61B0300199C3CCE7AA0B41BE64A42780D7EC701371A300B06092A864886F70D01010B04820100142585D704A47DCC29E48B1BEC21143A84708804A2CB80DDF45C51ABACD9F77983CB7D5A45744C9EB9140B8F978625F87BE147F3F1272C5DB5CFC7B352A54352C516B86CF7C3BEE89898F7DEF456EE9B26FFA76BE73E64215C76491085D6370692D0A63F928D1BC703A7597E8ADA38FE5D0914149FAFA13A3DCBE091AD74753ABB3F63DF61937A8C78358221C0BFBF11A14BC12A85873FA4ED795BCD36DBD3AA331BCE8F920D43C4B9A5F7C109C7AED8B5FD2FF20C92BC572D23A79A0E89EFDC5973CE61F4311A24F6930E12D71F5AC0CD9A89D63ADDC4BC303586E81048AE7579B89DBE91B81A85EF32B10A39FF3564E1D479B118770D9268A99F880A903F8D");
    let ci2 = ContentInfo::from_der(&p2resp).unwrap();
    assert_eq!(ci2.content_type, const_oid::db::rfc5911::ID_SIGNED_DATA);
    let bytes2 = ci2.content.to_der().unwrap();
    let sd = SignedData::from_der(&bytes2).unwrap();
    let encap = sd.encap_content_info.econtent.unwrap();
    let encos = encap.to_der().unwrap();
    let os = OctetString::from_der(&encos).unwrap();
    let xml = os.as_bytes();

    println!("XML hex: {}", buffer_to_hex(xml));
    println!("XML text: {:?}", std::str::from_utf8(xml));

    let xml_cursor = Cursor::new(xml);
    let profile = plist::Value::from_reader(xml_cursor).expect("failed to read book.plist");

    println!("{:?}", profile);
    let profile_dict = profile.as_dictionary().unwrap();
    println!("{:?}", profile);

    let payload = profile_dict
        .get("EncryptedPayloadContent")
        .unwrap()
        .as_data()
        .unwrap();
    println!("{:?}", buffer_to_hex(payload));

    let cied = ContentInfo::from_der(&payload).unwrap();
    assert_eq!(cied.content_type, const_oid::db::rfc5911::ID_ENVELOPED_DATA);
    let bytes2ed = cied.content.to_der().unwrap();
    let ed = EnvelopedData::from_der(&bytes2ed).unwrap();

    let binding = ed
        .encrypted_content
        .content_enc_alg
        .parameters
        .clone()
        .unwrap()
        .to_der()
        .unwrap();
    let ivos = binding.as_slice();
    let bindingos = OctetString::from_der(ivos).unwrap();
    let iv = bindingos.as_bytes();
    println!("IV: {}", buffer_to_hex(iv));
    let ctbinding = ed.encrypted_content.encrypted_content.unwrap();
    let ct = ctbinding.as_bytes();
    for ri in ed.recip_infos.0.iter() {
        println!("{:?}", ri);
        let dec_key = match ri {
            RecipientInfo::Ktri(ktri) => {
                println!("ENCKEY: {:?}", buffer_to_hex(ktri.enc_key.as_bytes()));
                let dk = piv::decrypt_data(
                    &mut yubikey,
                    ktri.enc_key.as_bytes(),
                    AlgorithmId::Rsa2048,
                    SlotId::CardAuthentication,
                )
                .unwrap();
                decrypt_inner(dk.to_vec(), 256).unwrap()
            }
            _ => panic!(),
        };

        println!(
            "DECKEY: {:?}",
            buffer_to_hex(dec_key.1[dec_key.2 as usize..].to_vec().as_slice())
        );
        let xx = dec_key.1[dec_key.2 as usize..].to_vec();
        println!("DECKEY: {:?}", buffer_to_hex(xx.as_slice()));

        let key = GenericArray::from_slice(xx.as_slice());

        // decryption
        type Aes256CbcDec = cbc::Decryptor<aes::Aes256>;
        let cipher = Aes256CbcDec::new(key, iv.into());
        let pt = cipher
            .decrypt_padded_vec_mut::<aes::cipher::block_padding::Pkcs7>(&ct)
            .unwrap();
        println!("Decrypted XML hex: {}", buffer_to_hex(&pt));
        println!("Decrypted XML text: {:?}", std::str::from_utf8(xml));

        let pt_cursor = Cursor::new(pt);
        let profile2 = plist::Value::from_reader(pt_cursor).expect("failed to read book.plist");
        println!("{:?}", profile2);
        let profile2_array = profile2.as_array().unwrap();
        let profile2_dict = profile2_array[0].as_dictionary().unwrap();
        println!("{:?}", profile2_dict);

        assert_eq!(
            "com.apple.security.scep",
            profile2_dict
                .get("PayloadType")
                .unwrap()
                .as_string()
                .unwrap()
        );
        let pc = profile2_dict
            .get("PayloadContent")
            .unwrap()
            .as_dictionary()
            .unwrap();
        for item in pc {
            println!("{} = {:?}", item.0, item.1);
        }
    }

    //println!("{:?}", ed);
}

#[tokio::test]
async fn get_ca_cert_test() {
    let url = "https://sw-ca-53.redhoundsoftware.net/ca/device-enroll-hw/pkiclient.exe";
    let get_ca_url = format!("{url}?operation=GetCACert");
    let ca_cert = get_ca_cert(&get_ca_url).await.unwrap();
    println!("{:?}", ca_cert);
}

#[test]
fn sd_test() {
    let mut yubikey = match get_yubikey(Some(Serial(15995762))) {
        Ok(yk) => yk,
        Err(e) => {
            println!("ERROR: {:?}", e);
            return;
        }
    };
    if yubikey.authenticate(MgmKey::default()).is_err() {
        //todo reset if not the expect value (i.e., not actually default)
    }

    let bytes = hex!("30820B52020103310D300B06096086480165030402013082051206092A864886F70D010701A0820503048204FF3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C646963743E0A093C6B65793E5061796C6F6164436F6E74656E743C2F6B65793E0A093C646963743E0A09093C6B65793E4368616C6C656E67653C2F6B65793E0A09093C737472696E673E35353533353735353C2F737472696E673E0A09093C6B65793E446576696365417474726962757465733C2F6B65793E0A09093C61727261793E0A0909093C737472696E673E554449443C2F737472696E673E0A0909093C737472696E673E4D41435F414444524553535F454E303C2F737472696E673E0A0909093C737472696E673E4445564943455F4E414D453C2F737472696E673E0A0909093C737472696E673E494D45493C2F737472696E673E0A0909093C737472696E673E53455249414C3C2F737472696E673E0A0909093C737472696E673E49434349443C2F737472696E673E0A0909093C737472696E673E56455253494F4E3C2F737472696E673E0A0909093C737472696E673E50524F445543543C2F737472696E673E0A0909093C737472696E673E4D4549443C2F737472696E673E0A09093C2F61727261793E0A09093C6B65793E55524C3C2F6B65793E0A09093C737472696E673E68747470733A2F2F7062322E726564686F756E64736F6674776172652E6E65743A3434332F70622F70726F66696C653F757569643D30373665386230332D663232662D343266322D613036392D37633933663234333638373126616D703B73657269616C3D31353939353736323C2F737472696E673E0A093C2F646963743E0A093C6B65793E5061796C6F61644465736372697074696F6E3C2F6B65793E0A093C737472696E673E496E7374616C6C20746869732070726F66696C6520746F20656E726F6C6C20666F7220746F20657865726369736520507572656272656420656E726F6C6C6D656E7420736572766963653C2F737472696E673E0A093C6B65793E5061796C6F6164446973706C61794E616D653C2F6B65793E0A093C737472696E673E507572656272656420436F6E66696775726174696F6E3C2F737472696E673E0A093C6B65793E5061796C6F61644964656E7469666965723C2F6B65793E0A093C737472696E673E7265642E686F756E642E70726F66696C652D736572766963652E33313761666631612D313962642D313165652D626665642D3065336562366136613564643C2F737472696E673E0A093C6B65793E5061796C6F61644F7267616E697A6174696F6E3C2F6B65793E0A093C737472696E673E446F443C2F737472696E673E0A093C6B65793E5061796C6F6164547970653C2F6B65793E0A093C737472696E673E50726F66696C6520536572766963653C2F737472696E673E0A093C6B65793E5061796C6F6164555549443C2F6B65793E0A093C737472696E673E33313761666631612D313962642D313165652D626665642D3065336562366136613564643C2F737472696E673E0A093C6B65793E5061796C6F616456657273696F6E3C2F6B65793E0A093C696E74656765723E313C2F696E74656765723E0A3C2F646963743E0A3C2F706C6973743E0AA082049A308204963082037EA00302010202025EED300D06092A864886F70D01010B0500305D310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03446F44310C300A060355040B0C03504B493118301606035504030C0F444F442050422053572043412D3533301E170D3232303531393136353331365A170D3235303430383130353130345A3057310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03504B493120301E06035504030C175075726562726564205061796C6F6164205369676E657230820122300D06092A864886F70D01010105000382010F003082010A0282010100BD9E57FAEA20C4C4AF323D8D5ED46FF71BB0F6E705A037CC425D33BE74F7CE06981C65975F8A4663BDF5F177B754DFBD17D386324189B8F62EB2FA361BA7ABF5F307CB5E69E81948C88E86E0642352E0033D61E3EDE4412BF870392E5CA85D894ED7748E687E1B4443E08AC06AA73513D4E5D4C99843873F470B143A302F1B3DEC04E8F63D988AEE170C16826129E94F000A816C541AD67615686198918197EF23A50C2B14DB04E2E175AE4D9440C9E6DCE9287514DE4CC09B6139779E0D12E07575C4A72D311487241E2D1E520B5CAA1E1F668B0A211114485744BD12027B92DFF3320ABFF7560C11D70C8C3C87DDB6D88D315C0656EBCE8EF06AA3F275CCE30203010001A382016430820160301F0603551D2304183016801461BF1745A00B56DC28F3EEC5FB6DA305C3B5F48C301D0603551D0E04160414D8D53B10803CBE8B58533012B4AA4D00F901D30F30818306082B0601050507010104773075304306082B060105050730028637687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F7369676E2F444F445042535743415F35332E636572302E06082B060105050730018622687474703A2F2F70626F6373702E726564686F756E64736F6674776172652E6E6574300E0603551D0F0101FF0404030205A030470603551D1F0440303E303CA03AA0388636687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F63726C2F444F445042535743415F35332E63726C30160603551D20040F300D300B0609608648016502010B2730270603551D250420301E06082B0601050507030106082B0601050507030206082B06010505080202300D06092A864886F70D01010B05000382010100926B181913EB28DE70DEC9D07DC782114A78513E820A575C64321039616C83BB4ED7E0C7B53F641E335A3F1191013F3B5222C127C59AD8E32A8E5E1D58BE8DA1895C2FDF480490646D604209A99898E3D469C9DE37746750DFB20AE22A68998064E630BFB1562132667FFB4C40D3A700757AA139A40243658F3FC5A12ECE9D9BDBE0F1B0B6D6A30FD0230DE69F4321E6AE9A3EE339622312EB8D1526D294F9D70E08B99E2E009D7D95923AC20226B322EFB3736AFB08D9D96E6A6C5BD7ACED8947EAC1AA29B79B7443F1F55C69C844CED9182762AFE749B9A21B78D3BDB98C3624021B459901FAA988AF910312F8AC65FDF720EF1125F1A8C2B7EE21EE3AF95731820188308201840201038014D8D53B10803CBE8B58533012B4AA4D00F901D30F300B0609608648016503040201A04B301806092A864886F70D010903310B06092A864886F70D010701302F06092A864886F70D010904312204206E293D0B305459CBADB4958F0A381A475B6BD35C32DEA24C0A6ACE6F475FC0E3300B06092A864886F70D01010B048201007F7D6386C5F98D7EB9224CB7B8C666BDAE6C5AA7426954B67A305C7AF937C02D5A9765C44B86D8EFFC144EC7BD6DC29F707572E9A8EA68059040E9C79A4E94746A549701072397B7FB4986FEDAD5BCD0B0BA17CB4DDB79365EE34470F5EC45A66C83E96730A051497D1E17F205DC285C375E3D611590BC7697D41E0CD6210474D415CE75FA2905D5D5E0F021B7C7EA835C62C7D00BF2CAB6D85CB988C88119682FE872B9ACF8BC339807457FB5235ADFAF7DE9E17150A4B32B877C382B9F9D19787A3C5D9E15AE2D93A6B4823DEE2A8C768D32BD4018B6FA59763349906EF5DD4A17E9CABE0A3B80F083471F1A99F4AAAAB5A97F1CD487D7BA382DE16748609B");
    let sd = SignedData::from_der(&bytes).unwrap();
    let encap = sd.encap_content_info.econtent.unwrap();
    let encos = encap.to_der().unwrap();
    let os = OctetString::from_der(&encos).unwrap();
    let xml = os.as_bytes();

    println!("XML hex: {}", buffer_to_hex(xml));
    println!("XML text: {:?}", std::str::from_utf8(xml));

    let xml_cursor = Cursor::new(xml);
    let profile = plist::Value::from_reader(xml_cursor).expect("failed to read book.plist");

    println!("{:?}", profile);
    let profile_dict = profile.as_dictionary().unwrap();
    println!("{:?}", profile);

    let payload = profile_dict
        .get("PayloadContent")
        .unwrap()
        .as_dictionary()
        .unwrap();
    let challenge = payload.get("Challenge").unwrap().as_string().unwrap();
    println!("{:?}", challenge);

    let url = payload.get("URL").unwrap().as_string().unwrap();
    println!("{:?}", url);

    let p2 = Phase2Request {
        CHALLENGE: challenge.to_string(),
        SERIAL: "15995762".to_string(),
        PRODUCT: "Yubikey".to_string(),
        VERSION: "TODO".to_string(),
        UDID: "076e8b03-f22f-42f2-a069-7c93f2436871".to_string(),
    };
    let mut out = vec![];
    let _ = plist::to_writer_xml(&mut out, &p2);
    println!("{:?}", std::str::from_utf8(&out));

    let mut cert = None;
    let l = Key::list(&mut yubikey).unwrap();
    for ac in l {
        if ac.slot() == SlotId::CardAuthentication {
            cert = Some(ac.certificate().clone());
        }
    }

    let content = EncapsulatedContentInfo {
        econtent_type: const_oid::db::rfc5911::ID_DATA,
        econtent: Some(
            Any::new(
                Tag::OctetString,
                OctetString::new(out).unwrap().to_der().unwrap(),
            )
            .unwrap(),
        ),
    };
    let cert = cert.unwrap();
    // Create multiple signer infos
    let signer: YubiKeySigningKey<'_, Sha256> = YubiKeySigningKey::new(
        &mut yubikey,
        SlotId::CardAuthentication,
        cert.tbs_certificate.subject_public_key_info.clone(),
    );
    let digest_algorithm = AlgorithmIdentifierOwned {
        oid: const_oid::db::rfc5912::ID_SHA_256,
        parameters: None,
    };

    let skidbytes = Sha1::digest(
        cert.tbs_certificate
            .subject_public_key_info
            .subject_public_key
            .as_bytes()
            .unwrap(),
    )
    .to_vec();
    println!("SKID: {}", buffer_to_hex(skidbytes.as_slice()));
    let os2 = OctetString::new(skidbytes).unwrap();
    //let skid = SubjectKeyIdentifier{ 0: os2 };
    let skid2 = SubjectKeyIdentifier::from(os2);

    let si = SignerIdentifier::SubjectKeyIdentifier(skid2);

    let external_message_digest = None;
    let signer_info_builder_1 = SignerInfoBuilder::new(
        &signer,
        si,
        digest_algorithm.clone(),
        &content,
        external_message_digest,
    )
    .expect("Could not create RSA SignerInfoBuilder");

    // let certificate_buf = include_bytes!("examples/ValidCertificatePathTest1EE.pem");
    // let certificate = x509_cert::Certificate::from_pem(certificate_buf).unwrap();

    let mut builder = SignedDataBuilder::new(&content);

    let signed_data_pkcs7 = builder
        .add_digest_algorithm(digest_algorithm)
        .expect("could not add a digest algorithm")
        //.add_certificate(CertificateChoices::Certificate(certificate))
        //.expect("error adding certificate")
        .add_signer_info(signer_info_builder_1)
        .expect("error adding RSA signer info")
        .build()
        .expect("building signed data failed");
    let signed_data_pkcs7_der = signed_data_pkcs7
        .to_der()
        .expect("conversion of signed data to DER failed.");
    println!("{}", buffer_to_hex(&signed_data_pkcs7_der));
}

#[test]
fn test_scep_response() {
    let mut yubikey = match get_yubikey(Some(Serial(15995762))) {
        Ok(yk) => yk,
        Err(e) => {
            println!("ERROR: {:?}", e);
            return;
        }
    };
    if yubikey.authenticate(MgmKey::default()).is_err() {
        //todo reset if not the expect value (i.e., not actually default)
    }
    let scep_response = hex!("3082163406092A864886F70D010702A082162530821621020101310F300D060960864801650304020105003082067506092A864886F70D010701A0820666048206623082065E06092A864886F70D010703A082064F3082064B020100318201523082014E02010030383020310B30090603550406130255533111300F06035504030C083135393935373632021401AE20BDFA4AD80E6F5A0D1034B231414C1F58D6300B06092A864886F70D010101048201000E6F434C1E0DEFED1B0DEAE70EF9B9821707737D56E026F1B76D3E3F74FF4C0A52FDD4BEB0770BF53E184E6C376820289358B20911F044E5F83103167964EF1B9FE88D0811CF576F3CA94E4CA13F8139EAD7CA1E6BC1CDF2080ACD9FB717239A3AFD8BBB6B84FE839675CBA24F695C2D525F498852994534A92514E12E5FCF5D055B6D474C840569FBF78454D32BD0B0ACCF220DB6C4ABB7BF92FBB6FA8FE0C6378C4EF0278D2A3EF8A670ED8B40FBADA22A9E440DA6F620E61A7D06EA0EC2A5EC24B0D8A9DD80BAB6A0E5642D359C209DE3883E399F759627E6D3587ED2D74B5F215104F8E65A3D586DF012933FC0A95E8D7BFD5C0042CCE787A57F02321956308204EE06092A864886F70D010701301D060960864801650304012A04108AB75DE85D0A49CD0BD63BE8391EB2EE808204C094F0372927E96ACF121B3D09CF8E6811C4AE38C5DEE45333796AAF9F4CF0C9BB0F57F657EF0BC3CCE47E89CC73AEA1959C8768F321FF0454E5F82DAC5FBB932807D8B5BC49C988B2A50DA18B0BD76C1888792EB9D9CEEEB5527CED93069F2A102AEB40D3B8C641E5138F0B2DCA56E40D9160F4D69BF7C362DAD2F6B7FC111FF9AEE9B0889CFBFFCCC0F9096C96F476CE02EC659137254DB8B7D94A29BDA52940087DAA84E1FEA1C4F660079A7DF990FF418D29BD69A43718CC78AEDEE0A8F5FAEDC8F12DF022AB948AFA047F87F286872B7A60C2B34128DEA7731862648B861C417A6637FF724B1172D2A28F3E0C3ABF253A4796DB7B3E89C2B692FC5C99E9962087D11E40DD0FE3372225EE2BE712A80FC78724BD709D5738882E0A233A81DFE49EDF1C619F9A7B8CF7ECDEA37E0CE7791E7618FDBC901CCE82F9CDEDCB4380171AF335E1C60232AE923EAFE65FB7C12F8B736B5C29BEAF1ECD1199AFBA4C22694FEDD1339345EDA7E3627515EC16D25D6C262A02C3A123F3ACA05010FD6E3FB5B89624E061849A9E69ABED1E240DEC208AED846D55F60533A36B466FB6AC815E0563E025D21C40EFECDDD42648D3B9E7B8584DFEEBE84E66CE184E9755E037BEB51CB1049BCDCB118575902653F1C357B2076F685B872719E4D28F92C0382E87E38E0A26958D780E3DBA93D8B820E2D737E61FEBF44919161601ECDB3B71477264D9A66280E6DBF73A5CA43A01C46C8EEB46853399076A82B445E00E1E0A76713B7918FC6816ED31C1C5F837BBA6C956DEE3EFEB12D8FD86575E212F56073AF857E52D82E60950F6C2E1E77282EAF2928B51C3819842B0335A2628C8AD379BFF57412F6D812FA63B801852AF511FDCB35B76179B2EAD64E251556BA6C5B845D8D9ED1F80885D9243320186A6A4402050D76C0420D0D2FAA066909D2C372387436E91EFECF650B0F4D68CEB9741A2809C2F23958A9012632CD4CC238896079EB693E734D47AE8001B06ABC996E311F01126E223BC1CEA4A0BE3A5DF4015D77CB9B705E109DCD2F661E6978AEB74C26A27920888C1B31079881EF6B1438C33E161375E577E678094478161375E1949278E816A197AD8C530A604DF798D610DC1162C58F80B2CABD699A8A74190824F03B277DF5F47A32F1EC9E1D850C9C647DAEFACAEDFD34C44F3BAA84711CC6874917D87691C899A83312BF2FE448DB947C0F914D04473211190A581701D07C0A1CDA13E9A86B95FD20EC25534FA5A90379B66B71DD86E3FD1F4F7CF21727BD13E80EEE371D4971EA2D1210B7467EF4CC62159A99F980D84CC59CFE2A5B27A6B3CF9D0DDFEDAFCDE9C0C2E6F66ECA322DF60D4F4CE4C3F184E0C75E47DFFCBC216C3C700E11F61679C592E59699A8994B13230AC3F2A5A23678FD270D8F1C9982CD6FAAE8E514F2AD84D5D5F0F4697F47EC9CEF120E1FA857363CB6DA83B81C506ACED98D9101194A431C5DECFB23C5A77D4C87642DB4EA3E83CE2E6B0EA61584A6A50632E6652481ABF1B0974EC2BE85135F43AE30122B92236AF637073A0F52ED9F1A0AD113B1944063DBEEFF94F9B68C3B68C6B91D3CD6F69885F78AA42493D455047A587BAA1D72AF1CD3500CA99E6F34E7462E93023FE1CBBB0F20CC1EDF66D60AE024D4F19E1677022171E6A3AFD1501221D24019224093B86B8191F0001820F6852715A2256292A733A205DEA1A78A0820CC33082037B30820263A003020102020101300D06092A864886F70D01010B0500305F310B300906035504061302555331183016060355040A130F552E532E20476F7665726E6D656E74310C300A060355040B1303446F44310C300A060355040B1303504B49311A301806035504031311446F4420454E4720526F6F742043412033301E170D3135313030383138353335385A170D3235313030353138353335385A305F310B300906035504061302555331183016060355040A130F552E532E20476F7665726E6D656E74310C300A060355040B1303446F44310C300A060355040B1303504B49311A301806035504031311446F4420454E4720526F6F74204341203330820122300D06092A864886F70D01010105000382010F003082010A0282010100D0BAD64306D62CCFEE0264452045CA797141ACA74113E3E99F5D111F40533902187B92F8BEA755D0E1C0A6C27F36154F3B623D3E05D23114CC8283F466E3AF53964045CF3CD793D459EC82FC6A8B4D11F21638ABADFC0A83C0728A584DD4C692426E0EBD5406915B94148C4C59F24E55546364553B088714BBE44695C73232FF9F76B233CC2F91D6DF03D97736C13766E106D475E8D391EDBAA11FF7935652D5DBFCDCCFB9AB629FAA03CBD8862508302774C9AADFC3ADA5A9B5CAA54E2E7AD63519D04145BD394C46498AE551DEF96B52CB57715BCAA8FDEDF5925733E28092B367BF5B4AC1A16710DE8FC30F1D65B955E9B86D0DD03CCAA39054A86025C3510203010001A3423040301D0603551D0E041604145F3C9326782125535FF9A770CBB82BCF4CD33561300E0603551D0F0101FF040403020186300F0603551D130101FF040530030101FF300D06092A864886F70D01010B0500038201010033C75C517B23F80275253E997EAA8D31C1FD39602EFAC253583E0BF5D865BD311F7EEB1641CE703B04229B886D524354EC3AA001A39DDA01892BFDC33541070D6D3EC87FD803D924DC064746F2820CF66D22A92E0885FF58C92C07CD08563A972BD26DECCBA467C909EA5CD07294C6FAAA5B89391CE88232463BB341E0A82F6BB677D6BC9DFA7D807F425D5966D56965C5152F8303025418193BAC0687D147FFD1ED5CA151C198F5733922A71E26AA4F522C091522E69D84ACEBD33C412983CC7AAAD71D9E7E1BBAF5857DBC2DFE34F897A020E53AC9B28172E34941ED16D6AF5724BA142B01DC665DA38C9C2DA9DDBA9AC5284D18AD02775B7AF7121D69E1603082045F30820347A00302010202025EF7300D06092A864886F70D01010B0500305D310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03446F44310C300A060355040B0C03504B493118301606035504030C0F444F442050422053572043412D3533301E170D3232303531393139303935375A170D3235303430383130353130345A300F310D300B06035504030C045042524130820122300D06092A864886F70D01010105000382010F003082010A0282010100B461F88AD6422C98F00E7FABB8F70DEFC6BC77F4BAD656C7BC44A23AF5DBCB1ED45BCBB266B4A9C5545FE6FAF0D2C2341E75DF22FA8728B85904F227CED19A73AEF01F0037873D9198617BA1CC1F6BAC7D7E47E070D6075FFEE27C266E1AFD371070B840AFB85FA3F8FC3490BEAD22B68897F14E27832E3FB619658B9B5E2034BD49FEAB791707B177F656A94A19012A214A60A535D1920CE9EFEFB9155BBAAAEB1E0CB40362B5C352797013E53CE4F026DD2B5BE711E45CB6FDCC95330CC9E9F3051AC135E5CD7D532C6B225D396B99232EEAA0E89C765432C5B6692E721B17514F2351476FE811619B6E3C3B7C5F4E42C7268595E4DF1A0B131D61209F45D90203010001A382017530820171301F0603551D2304183016801461BF1745A00B56DC28F3EEC5FB6DA305C3B5F48C301D0603551D0E04160414680239301CBABB82D9319FB160DBE972724A928B30818306082B0601050507010104773075304306082B060105050730028637687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F7369676E2F444F445042535743415F35332E636572302E06082B060105050730018622687474703A2F2F70626F6373702E726564686F756E64736F6674776172652E6E6574300E0603551D0F0101FF0404030205A030470603551D1F0440303E303CA03AA0388636687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F63726C2F444F445042535743415F35332E63726C300F0603551D110408300682045042524130160603551D20040F300D300B0609608648016502010B2730270603551D250420301E06082B0601050507030106082B0601050507030206082B06010505080202300D06092A864886F70D01010B050003820101004D3829A3DBE19BF3DC437A46BC3098F1C429418FBD080DC551480BA6226EC591581E228AD7AE07447E9E16EDA32B84DB1D7544A295B5CC5DCF76BD5DF9C6A1CA8573789E45E97B327F91CB1EF1F9C0D05776F2ABA7C583EF443EB18F9DD376476DD96066586251A4F70595AB53715039608732CECDF96908F3BB788A7BC107EC13C3B8B299405CBB9F8C008BB348C1EAEF1020309513FC019E4AA7A143BD6F4CBC01300C5A8319DE50F3C0F830A6C1ABBC857FF46B71936307075B10CD47AC00D39984E9E46D3E4529C7BE8341A9FBAE5E5B86715DA63B235E97601D61C880F427268021A8037E646FA56E468566CBFC64AF4A4814FC14E7952B86F8A29893AD308204DD308203C5A003020102020129300D06092A864886F70D01010B0500305F310B300906035504061302555331183016060355040A130F552E532E20476F7665726E6D656E74310C300A060355040B1303446F44310C300A060355040B1303504B49311A301806035504031311446F4420454E4720526F6F742043412033301E170D3139303430393130353130345A170D3235303430383130353130345A305D310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03446F44310C300A060355040B0C03504B493118301606035504030C0F444F442050422053572043412D353330820122300D06092A864886F70D01010105000382010F003082010A0282010100C0DE3FFAC25EB51FAAF407B3FBB9EB9E6C11C938ECFBF195E4FECC0EA3309AEE150948A4504EE958E11BF5C6817EFEF234EB8F11D8A876169730B0299DF1400E8D44D799DF598B46503BFD142A8C6CE6C98A61FB4963D64C63B78670693BB2A2299A0E9B85E7B85460B70C471417052F6A49DAA259D368CDE6540A28C85D4489F0D361D0ACF3FEE472D085684916DEE852B85380380B73A72D65FED1D21FC57ADC4BECC6595B29C25FE53A4291AA4A4FBB2FADC869B738DA8F374011A224EA5F27950D173E5436BD546B587D43CF037BDB2FE0292349ADCB3F76494F09BE82C0D3E063D82E7589A4DBA3592DFE0B1C150AA22F28A8D29494580F808FEDBEF6B50203010001A38201A4308201A0301F0603551D230418301680145F3C9326782125535FF9A770CBB82BCF4CD33561301D0603551D0E0416041461BF1745A00B56DC28F3EEC5FB6DA305C3B5F48C300E0603551D0F0101FF040403020186305A0603551D2004533051300B0609608648016502010B24300B0609608648016502010B27300B0609608648016502010B2A300C060A6086480165030201030D300C060A60864801650302010311300C060A6086480165030201032730120603551D130101FF040830060101FF020100300C0603551D240405300380010030450603551D1F043E303C303AA038A0368634687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F63726C2F444F44524F4F544341332E63726C30818806082B06010505070101047C307A304806082B06010505073002863C687474703A2F2F706263726C2E726564686F756E64736F6674776172652E6E65742F697373756564746F2F444F44524F4F544341335F49542E703763302E06082B060105050730018622687474703A2F2F70626F6373702E726564686F756E64736F6674776172652E6E6574300D06092A864886F70D01010B0500038201010069DDA84BCBA248DED856D3C04C29696120106325692A9F48F9174348282EB283508CD97718B651779615B5843081B5084708EA3011CD81E8A27CE706A769999E1DF6123A74ADF4B932B3C6784D31DB729B89C158BC6ED3A4855BA368499180DA333E1540E5504EB1CDA9F67479768C01C5C9C9A71DBEB8379744540463474FA9D2762EC929076DDFC0AE199B521DE3C14CB9FBB4B4A60E613B15392B68BF781D453BA8199A32B6344BFCD0D12A2578A02D543995460FA24EE6AA64999B3E79D997A11E91091291C37F201FA701C5ED5487A63532409A454EBB20DAECBCA9083B64EA30B49D746CE85BE1852DACD1657B17D0658A86C3B5289AD407E652BC5000318202C9308202C50201013063305D310B300906035504061302555331183016060355040A0C0F552E532E20476F7665726E6D656E74310C300A060355040B0C03446F44310C300A060355040B0C03504B493118301606035504030C0F444F442050422053572043412D353302025EF7300D06096086480165030402010500A08201373011060A6086480186F84501090231031301333011060A6086480186F8450109033103130130301806092A864886F70D010903310B06092A864886F70D010701301C06092A864886F70D010905310F170D3233303730363133333635305A3020060A6086480186F845010905311204109BF7B537428233F7F95513F595E1E87C3023060A6086480186F8450109073115131354657374205472616E73616374696F6E204944302D06092A864886F70D0109343120301E300D06096086480165030402010500A10D06092A864886F70D01010B0500302F06092A864886F70D01090431220420F778A489EA63AEB35629DB7076D543008A207EE096F3EB4BC7337F255F89F2063030060A6086480186F845010906312204202A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A2A300D06092A864886F70D01010B050004820100310E68DAD7541549E40BE3B72740B56D6C70C34F043EEA5E8493D64464961C9E816BFB0280E4603E2D710483776E60E98DA25CB049E5DB5010A0330110D86A2AA50BF20C4DCBF5477DED9973B7F690E01D9A3167E52FA5F8C33EFDDB6B285AD2D9244B8B3CE03D27902ACFA788A2954E2E20B886B857895A8F66E7F75D017D1BF751057AD35471AAE9C6CF9B7F14487AA4631C17675A0C7ECC75AA631C26D16A3C844047C55FABC4DECCB24FD7E0C719BA6AD5EC09B8147AE79AAC89E588872B9BE230E5BA0F2D4C952C43EA0E22556A028894E5E26582F5B72FE39D24D887D2D3F21DC936CD68F4B98B98A4C2CADF6B510185A99A1F32BC24FB7E10AD44AD71");
    let dec_content = verify_and_decrypt(
        &mut yubikey,
        SlotId::CardAuthentication,
        scep_response.as_slice(),
        false,
    )
    .unwrap();
    println!("{}", buffer_to_hex(&dec_content));
}

#[tokio::test]
async fn process_payloads_test() {
    let mut yubikey = match get_yubikey(Some(Serial(15995762))) {
        Ok(yk) => yk,
        Err(e) => {
            println!("ERROR: {:?}", e);
            return;
        }
    };
    if yubikey.authenticate(MgmKey::default()).is_err() {
        //todo reset if not the expect value (i.e., not actually default)
    }

    let xml = hex!("3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C61727261793E0A093C646963743E0A09093C6B65793E50617373776F72643C2F6B65793E0A09093C737472696E673E5D457452454F2C63782C302425423972716A5773357C414A26616D703B42716430494930564C7E2667743B494354407C507258562E38314A6B3F46626554667B58522D456B507552743D35655C4C6B304E327C772F76515230435F79757A2B487C2F6674325C2667743B70555E2F4D72506261713F237B6D73363326616D703B34404B326E66543261535167652B3C2F737472696E673E0A09093C6B65793E5061796C6F6164436572746966696361746546696C654E616D653C2F6B65793E0A09093C737472696E673E7265636F7665726564456E6372797074696F6E2E7031323C2F737472696E673E0A09093C6B65793E5061796C6F6164436F6E74656E743C2F6B65793E0A09093C646174613E0A09094D49494C46514942417A43434374384743537147534962334451454841614343437441456767724D4D49494B794443434258384743537147534962330A090944514548427143434258417767675673416745414D4949465A51594A4B6F5A496876634E415163424D42774743697147534962334451454D415159770A090944675149695474562F624B786F32494341676741674949464F43515257344D447055586764666B302F716A4733476F424564622B37643851364574490A09096444472F57693064332B6B333561364E46765A375A6B4138415956373931695572645A4F644359382B436B2B364C4D355476615862655643387650670A0909664552437946726830684B6A417464664A58397667774642375A46663259306358576E7A7A77486D4F6A635A7A396D46533165724E323844346378680A0909382F6253525063314136693371756D725158445073586F4B5845684A475856695454513737622B354D626E4946356F6D49536254503173676470442B0A09094868315045626D3869787269574246556753624C6A6875505370776A314A33336F4C5A3455332F56694C5A4635446C42517337336D365152624578480A0909435834612B452F313342786536733151566F56687A4C384148332B65505473393275735A65363163584A67785942575050794D57776C32706358564F0A090941782F58707841354A4661662B533054446F564C4149456E4A50612F46777073323753526971544433577042744E4D625871467166656A2B446738740A09095535363132766D666A2B34523437646C65614872525759372F7873626A7044453476443947435131575862346731324E4533304D4C707467735238350A09097474565A744433536944732F79523354616B764136377843413368795A2B5A784A4970496C566C617A7543493166332B6653377152496B79326372420A090979473132546951392B676E345255326A35574F5A6950664B344E365732516D4277676746786456626B74533641504E677154745049733651487765500A0909437134326D425562594A6A634A47647A4F6B474871437A623478772F356E46754456504D34796A5A70425A7437612B6C48337669345A6F33784D77350A090953794831557A34776F487545653858386F494237307063786F6265394363414970465938485633665432726559575675436A426861476334676C656D0A09097869625165715530535A4D585754424A4A374C334248477754777855556C4F47427077776C71784D413252654379565A6D554E6E5970595A496D2B330A09094674766C6A773333562B2F6E69797A3478594544537A477A4D48426F7175716C75757A39422B396259726A6B76444F56434D2F4731724F65434F694B0A09096B5876633243333174442F41536A7675445A703763695545673442795066496A363653326F62564D3170565635695A34414C534E7935514E653874410A0909537143626F6B662B38726F5A31312F6A334871694F5A76466764676665722B6974725170755859686C437244394B58717241647468502B597A6E55560A0909416368676932457434364C302B6E33503075746D3844384B686D4E53325A6F4F59556D4576784A31377671614D64724D74594A3939565774347A4C620A090976322F4A49306E504E4D66765676626470554366466F7134775A6B3170534B7A794C45354D476553644449355A5A336C2B492B4F46774F5074462F4A0A090941587243743668344E32746A6F30644C6357574B644F67722B31704D32366559355762376F5956426637675144795548544E78626D4B3732654C6D550A090961565A41485473746A644249527436353568594E6B704B652B4E554D74507A4E7353486273306A78746F4737394B664F4F44376B50416C434937584F0A0909594F38545969587772644A33465A3459475878696A2F4B6275324C4C5046616B565639742B696F58636D2B6F376A3032414C41744D5A4F58545578300A0909354A30327A62756154713249356358726836614E2B5355486F46487472366E54312F4E33792B45396D2F76752B3976526554636C6A33664D2B34426E0A09092F5A58524155753955393034394B584D694A6B596E4E46594671326E70715276662F454A4F6C7641796473424F69396D5A5A38397A516565514846690A09094543354E7A3471767A516876477135784B7956355936644F61444768375259502F59574270317672614737334C6A367A6850644931557147557A32300A0909596541724B4D7638515A457A427755516643316B716F6D427454306D6E414E50456263736D524A795A72356D77735152432B55536664344E496A364B0A0909446E654D744A5A3067354E706943497939695131746578596576477566324964476A4E4870384945726E2B496246663179313778356F3836614457430A0909704D587330484A4755655A7136466E6335594E3265316F4F4A644C67556A7967752F71496D474A7353503958627734515A76515A7946466C5A6B6E650A090941416B68706731693177325268742B5238414668445767387664396C67674147755A7747644B6C32464550314A70544A644D786B32386A75686667490A09094C4439636E5A734952463933646F514E476A50456C466C31696D6530364234547333466E714874457363796B6F4E34705951713377365A6F6F4343650A0909666C326350543239735838494849466349383239622F434342534679656B4473652F52564D7567654B35635957706D49345837456A53566B376864370A09096851346A397530776767564242676B71686B6947397730424277476767675579424949464C6A434342536F776767556D42677371686B6947397730420A090944416F4241714343424F3477676754714D42774743697147534962334451454D41514D7744675149544772454D76576E334B6F4341676741424949450A0909794F3841664C54352F682F4231695432555046574E36775A65302B522B717276494B57584F6B34736E4B78304557366F6961317643563748482B346E0A090947666A6B466E5A3166626B4C4D32584D323138702B516337342F33635A6F374553707465782F545742582F4E6F5039346771346256676168346B496F0A090962577173372B58366570302B524E74526C33304568526F61655846665678464E7742694C4F377948435476464C4257584A644D4776593450575679540A0909616D427331526D6E38774731655471774D47333856534A5967374A304A54376F49363266737156736F2F2F477876654D4D4144463974505876532F430A090935513738387636614E7A48436A6848557139614D58675666586C5959423678536D4C697A4C6F4C4F4B704D763641653469342B416C4C617A43706A570A0909464C756E78474C457939746D3146787145536B74696B614773753073494F79484B52384A483377455056327671713448693438474A57656D6D67746D0A090930344B525646545A526678574E35364253366D66794A415957306537304D497675673565307857637A2B53532F6345556C6B75535541786B527259740A09096A656B376B78722F3764446C42336539424632612B50584D74736C544756505A703964356A3644764A5263364659754E497A576E697669694B6648300A0909796B4D30427343586A50436F4933644A6B756B4663635A58676C6B67476356556F425971454C6738764E495762584F35326A6F414A67726444322F7A0A0909355874487164564436367855316E6952554449547A356D68754F51374F6C784E496756485375794846734D66785955414F7A6E6C68454E38395577770A090938586E483154355346554F416C343335333234704B4649547353324A2B784B4939615276637A4D5376464A522B3058425A6973624D6843526A514A540A0909394F3534616E6A6D5A76736369666955707A57714E656969783841562F387343464B673338483463746D4A7A584F51536466374F394A6B4562756D520A0909784A764D4763334D6A566376374D5A3344724B7736424D786D63524D734534556B446F347138596546725558697174743374517148395944634D336E0A090963514E6B4E6A4E6A38436F79374244774857485666556B726A6132747165674355755A616A76316E4930686D79612B4A6177794A565679326F702B310A09092F75496C51694E33502B4A617347446B50546C67592B6E63704D3874517046375A4877642F7733685933436475384F7941444143674B38537944364E0A0909574461352B414E316A77394F616354786451314967593465316F68775569683941675259786F3154477A51435353773959304E4A6D335952334E67360A09096646784F7871727A7878335A54574477786D796667694F59656C4748626747593346446B38533356396242344F503456582F363753483536684379670A0909395747594D656978786A614939752B326F5853514C2B586B495941545169626C336C6B4849446B434B65505246416C7350766555467A506F4F4E6D390A090934303852726C734C38427A654F6E352F30746E614D6542516136374A574331355852516A523955464D33364A3058633956555875474B454C717743640A09096B56544D45415457414E4152736932624633587A56517947475A7035657072397362757458745570576D626D6D6857327A4F334A69524F77496D78370A09094750365A62382F4C6431495669576A7541746E505350455273424445306C6965725A566A72414F48356F5A2B776B6A41647971456C355075474D37300A09095634595142437A2F515741532B5145775650665941316D54336274756B5966597769317759684C6864336D64635547787157754E4C7570304151734D0A0909472F4B32574D715A723369376E775478575972523074567949566D78712F33375058327742475271396E556A74704D69674C583544366C6A387770390A090979622F5A35674442722B53573337416F5469356246303178574974393641533833506E2F71425A53326B7257536D396636446D70785A7948646546430A0909517770776A354A35545679507A514D3777573478517070627076667A446B52787A4D47363549584E4F4733353233483656335277785142763133772B0A090954475252563033757666552B30527A35465644444C322F5572536E4B635A4B50546C525A71525A6F494C7058304A2F762B307A3466544F5057547A580A0909775861565430344838584F62696D7A5A4666317737506A4C75463550523249424C7A544A4D5A3451386F5A2F344355734D444F4542794E314A4569410A0909736F373644665267766451427644456C4D434D4743537147534962334451454A4654455742425149626964626A70785544314C39312B4B594C444B5A0A090968695063374441744D434577435159464B77344441686F46414151556E366E69665830485056724356446741434F484F344C487679535545434E73710A090963582F45396B465A0A09093C2F646174613E0A09093C6B65793E5061796C6F61644465736372697074696F6E3C2F6B65793E0A09093C737472696E673E5265636F766572656420504B4353202331322066696C65207769746820656E6372797074696F6E2063726564656E7469616C733C2F737472696E673E0A09093C6B65793E5061796C6F6164446973706C61794E616D653C2F6B65793E0A09093C737472696E673E5265636F766572656420504B435320233132202D2023313C2F737472696E673E0A09093C6B65793E5061796C6F61644964656E7469666965723C2F6B65793E0A09093C737472696E673E7265642E686F756E642E7031322E34616661383532342D316336342D313165652D393238652D3065336562366136613564643C2F737472696E673E0A09093C6B65793E5061796C6F6164547970653C2F6B65793E0A09093C737472696E673E636F6D2E6170706C652E73656375726974792E706B637331323C2F737472696E673E0A09093C6B65793E5061796C6F6164555549443C2F6B65793E0A09093C737472696E673E34616661383532342D316336342D313165652D393238652D3065336562366136613564643C2F737472696E673E0A09093C6B65793E5061796C6F616456657273696F6E3C2F6B65793E0A09093C696E74656765723E313C2F696E74656765723E0A093C2F646963743E0A3C2F61727261793E0A3C2F706C6973743E0A");
    let _ = process_payloads(&mut yubikey, &xml).await;
}

#[tokio::test]
async fn recover_test() {
    let mut yubikey = match get_yubikey(Some(Serial(15995762))) {
        Ok(yk) => yk,
        Err(e) => {
            println!("ERROR: {:?}", e);
            return;
        }
    };
    if yubikey.authenticate(MgmKey::default()).is_err() {
        //todo reset if not the expect value (i.e., not actually default)
    }

    let p12 = hex!("3C3F786D6C2076657273696F6E3D22312E302220656E636F64696E673D225554462D38223F3E0A3C21444F435459504520706C697374205055424C494320222D2F2F4170706C652F2F44544420504C49535420312E302F2F454E222022687474703A2F2F7777772E6170706C652E636F6D2F445444732F50726F70657274794C6973742D312E302E647464223E0A3C706C6973742076657273696F6E3D22312E30223E0A3C61727261793E0A093C646963743E0A09093C6B65793E50617373776F72643C2F6B65793E0A09093C737472696E673E67236E6A3F5A5F6E745729344E445741334B2E2B444F586C3455767B667B673A7A3F587850685B6F623D393F266C743B446D6D6D6A686432475A4A38672C6E79695F75294C706A40346F764E6A317B26616D703B6F6C4A68323847672D2B612443367C5D5F4F6D716D255F3F2C4C5070266C743B737A476B4270382E326552394E377B7723592F4744783C2F737472696E673E0A09093C6B65793E5061796C6F6164436572746966696361746546696C654E616D653C2F6B65793E0A09093C737472696E673E7265636F7665726564456E6372797074696F6E2E7031323C2F737472696E673E0A09093C6B65793E5061796C6F6164436F6E74656E743C2F6B65793E0A09093C646174613E0A09094D49494C46514942417A43434374384743537147534962334451454841614343437441456767724D4D49494B794443434258384743537147534962330A090944514548427143434258417767675673416745414D4949465A51594A4B6F5A496876634E415163424D42774743697147534962334451454D415159770A0909446751495237354230447058324B674341676741674949464F4161764833786738543870794D43396B36675938764B7A77585A77514D6847505137520A09093533494E714A50664B58707872794D71643938526A796A4250356438616C487336563764467A4371656E676E672B4A6C486D2F774B32524E58444C520A09097A50704F594E704C79347A6E4B487976586758776A4B64376568646855794249667A494B30774152312B5036512F3339375136327749554C507645440A09096769524F344C7072383730514359374252422F664E33797267634D367A39494E526A534E4B58353335742B7A417450794A6F4D5A594949524342467A0A09096F62386F5530536C58533076487237546B2F31434F784558666A6130506548323946793367422F52526B79794934484D2F316B68474A4742497768750A0909457449724E7961436E45594D77506D79584D71666A484647584C47744176796E52505534546665736B4B526253444956585166396E33615657777A6C0A09096E636E396137534E6E6B3952724651766B745449714930467336424D69563250456B615950744B584C756442423837484D58344D4D7530564E6D4F770A09092F58434476736E5956456654616D7650304F69592B4D69504349726A4161623333427A6B6F7A37516A706C662F676458724F41676148645A547954360A09096E364D4E324C7162736A4E473455676B4E594C6A503539537A67426C35484768525A674B796C3059704D4D433464437972656530637748575270706F0A090970397243424956622F44594E6861427030654A6A4C425753334437436D5051574A762B7A7534587233566E7A6F734D377359496438455A66547A557A0A090942645250375A755569796939304A7557486B34627975476F366E416667326F786A2F7A2B383256616831346D7339556F68753635795871624F53494D0A090956306331714D72454B72334F542F565751787454384B704B506E793034612B34796F3463696A4665634D54776B4758646A354D56435775344956414D0A09092B4A6B62766B68525A4831384242714A6C6D5333722B6433544F70746371554863342B4735304A75714F37786A5374374D7A497858714E77425477510A090978766E67445756515A67656E3778485552637061496E674A474130314436484D4D6C426A43376E6F6F6E692F364C6F52476F6A337A633971426964370A09092F752F676F4847786B43457354387577534D6F7174632F31752B624E622B5430514363786A7A75585A6B697276655944306662564A5558337455626F0A09096E31645A454D794C6D57557747307A71507046657273416163494752484778626532637530642F58765132666D5056376E5750702F784747555A43540A0909416D4561573154654E4C2F5474553472797133594E712F32635349324462356F6A6643767155774437734D6C68356D696134635A49475A64627770570A09096537395133785A4C71506572746638537A6B554777776C556E676A6638765164537A317568646E704268337571444E53674564744E354A3535514F590A0909475A6E6F68383263443331366270742B6C73333646355230532F4261324E59773459584D6C5668754F695969476D68452B78785077724C56787333390A090978376C7479587957797067457942336B6A39364C506479705A6369686A742B645A6274625545424E553462392F6846726765376871774A6C584930650A090949666F4B74355A757577486D64766D7A377571337A506346716A586F7278655A74662B7344646C4B69345A56396C627359612B2B5135756E786A70630A0909704B513859766270715757547670566A537231414836504A49494B7731393348434B6D2B63737561525536473269656F77664F676136674C484458350A09096E5379517A516549446377523355783279577A664E762B76774F712F6F354A75734B546967444E596951422B43446E4E704D3648376A513555646D6D0A0909472F4C556834314F7938466C6A6875697769736B514D47786367633870354F4E77445958593856536C426A4F313247726644372B5379555354454B360A09093330354636305373796B6377666D6C756C6B4863353263396637327341662F7379794C72777838742B556C376173682F36615A41446374504741696B0A090945314F4C77762F7135596754364579616250427351385A5A6C3037784A744947576F4B3944534F6C6932773962623279507A64766F366535687563620A09096E36373638476D762F6A77744239783369676C5375794250636F45476D67493463744B48597943596F4B4C6D444C796744344332364D487577414F720A09094B3669525231443148395878794B4F61305438364F4F484D4F5A2B366F595A552B6B766A2F4F31334476433442445550654349573862306C6E72666A0A0909356A67504C743451533176705171356C472B6539702B4739345A57463655386C554A41614B4E512F586A534C45645A2B5152784B515277522B6E2F750A090946417A5544566C75704B5457516E37344948674C4F5230576331634A3147366E7635663531665A4D3041726F486A386847716A3175615A36756234690A09094257374E5A3138776767564242676B71686B6947397730424277476767675579424949464C6A434342536F776767556D42677371686B6947397730420A090944416F4241714343424F3477676754714D42774743697147534962334451454D41514D7744675149505A5970325945424C71384341676741424949450A0909794155654877696B5469723379613049576F566C4C6164736B48716E66414865506843304E526C5071494C5770425A6969486E587336712B44424D460A090967746B5734735054306E66692F495045435868614F5136745A55496E512F4D7636646C5274322B484270736D4D694D35586F504966443048663972580A0909774869586262744D387A6E31616E556E54727949305444724A666E67646F734F5353644268394C374848687732546D4B4579664F4B4B466F4C3050490A09096D4254364772346A734D7034784E46505172766B492F64706F67646C454F74466C316765326F5437307531395941784C514A43387A5276595859622B0A09096358494C743349734D3938706B4555644D4B6431396864497A6D4E36795249645A7577686E5356657246364E6F44724166356236357A6871737973630A09095A4469704C39786766674D4D5535773944464A463076797849495079705864474F46644165647667502F546C585434594B6B6D44516774764A4E42330A09092B7671315A674553687379667561762F505A66304B705A712B41744F7355766F35694458324A424E74414266746D454C4467306F61344566335368690A09096142442F6A33725752323843755546476870585A73413138716B625A5072417474536B4132554D683172776B3941647070674E6230454147634956500A09096745435567657A4D746A3432594334752F6C5045794F794830436963566D4732527643437338496C427255565939475A79304530736C4253384142750A09094730535A4F4E694A6475594A6430562F325A5558504A6338475468766250736A31737A593532317679514C6E6C454267346B346D34326F492F4945410A0909392B2B3976554170726C533550484233317976354D4A49596A3536644857574E6F4F68336B784233316A66424A636470446241496B57683763682B520A09096532735535515A67304D385A5038735747774E6D624D524473386764437638324B684C5773356F4E3072694837386A5254734F696A303572597266680A090979517A753233644F756F5135794C4277766C4E777362766D434D37763146377963386A447565724B38646F6355416D6859616F456B776976694B37450A090964686675397030746C7775742B49506271333147437574684C315A45375244446E2B3570615A78617430445A737A54376B6D2B64374E4F35594C614B0A09094D3256794F62475843737A326B456865394D73647A55474750656C4431415A6D7A74333745504A39384A37384E594A68484E496A375848337575354D0A0909703279766F39625856566B744D4F614C6652526F58665042556C656E4F30626A706C3177594D614F526439446E7130374A3243626E565269622F55590A0909336E3376474C784E70515738437970534E324F675430624D4F2B574F653841644B5A507069614E6B37634D7A5830557367674B61375736587861364D0A09095430564561636E39434E6A344B4359784B3853304575755A4264446B6E453751704F6747717472685A6F67394E3461664E4C6E4C324653414B7234310A0909554A6464572F62373563764A5967636679722B6B765A796D4C5877586A4A6D45704871445744476A4A426933767131322F41722B527A5378315071780A09096B4A654C693430643443387562766E523253385A387748474A49626C5333705A734D765934366E71446E5269517A707A4C616F54704A684863706D670A090943477432585735615A79446A46344A724E5A2F665046784343354B354F4B33454632496F50357355416B4F4F50524E3678506D564362743231767A310A09096558746C423978534966306550617757373850616B356C676249304F51384D7661414A47325878744E466C6B5766504C505133484152566F3745564D0A0909594C614758326F35416C6D56783552582B41356E465148643043457A6E5771554F655A54694C354C4149784F323958724B345A3354354939366A6B420A09094A326647546F6A374A463533765050734157355947663475384169646D5744697A5A6D564C35797A786F65716E56385730424D6577713355485933350A09094B4678346C415838776735666C3439784D693064553437596D486F63594A61377477653671555449444D396E4C386E545375376749496476386D622B0A090954444D37344E3132496D774D433255506E3932776E77557553636F462F4E5879455273547765776E7244684433386F776C6542376A615661446153620A0909616F4368476D515841745A637174443345466A7173374432754E2F734A68796F6E39545852566369536E49417A3661517759756E44434D786D44715A0A0909696E3664374F3268524F31694F6A456C4D434D4743537147534962334451454A4654455742425149626964626A70785544314C39312B4B594C444B5A0A090968695063374441744D434577435159464B77344441686F4641415155654E4C66484764555978703673762B36787934426C6F616435636B4543426E2F0A09095775647061665A6E0A09093C2F646174613E0A09093C6B65793E5061796C6F61644465736372697074696F6E3C2F6B65793E0A09093C737472696E673E5265636F766572656420504B4353202331322066696C65207769746820656E6372797074696F6E2063726564656E7469616C733C2F737472696E673E0A09093C6B65793E5061796C6F6164446973706C61794E616D653C2F6B65793E0A09093C737472696E673E5265636F766572656420504B435320233132202D2023313C2F737472696E673E0A09093C6B65793E5061796C6F61644964656E7469666965723C2F6B65793E0A09093C737472696E673E7265642E686F756E642E7031322E34393233633437342D316336322D313165652D393563312D3065336562366136613564643C2F737472696E673E0A09093C6B65793E5061796C6F6164547970653C2F6B65793E0A09093C737472696E673E636F6D2E6170706C652E73656375726974792E706B637331323C2F737472696E673E0A09093C6B65793E5061796C6F6164555549443C2F6B65793E0A09093C737472696E673E34393233633437342D316336322D313165652D393563312D3065336562366136613564643C2F737472696E673E0A09093C6B65793E5061796C6F616456657273696F6E3C2F6B65793E0A09093C696E74656765723E313C2F696E74656765723E0A093C2F646963743E0A3C2F61727261793E0A3C2F706C6973743E0A");
    let _ = process_payloads(&mut yubikey, &p12).await;
}
