# pbyk

The `pbyk` utility is a provides a command line interface to enroll YubiKeys with a Purebred instance. Purebred is a derived
credential issuance system used by the U.S. Department of Defense. This app is not an official release and is not
affiliated with the Defense Information Systems Agency. All testing has been done using non-production systems.

As with official Purebred apps, enrollment requires the participation of a Purebred Agent. Specifically, when enrolling
the device, you will need a Purebred Agent's EDIPI and a pair of one-time password values generated by that agent and
provided in a timely manner. When provisioning user certificates to the device, user key management (UKM) one-time
passwords (OTPs) are required. These can be obtained by authenticating to the target Purebred instance using the
(simulated) CAC credentials from which dervied credentials will be created.

## Workflow

The workflow consists of four steps, with an optional fifth step that can be used to recover addition escrowed keys.

- Reset
- Pre-enroll
- Enroll
- User key management
- (Optional) Recover

The following example demonstrates enrolling a YubiKey device with the serial number 15995762 with the cooperation of a
Purebred Agent whose EDIPI is 5533442211. The first step is to list available YubiKeys. If you already know your device's
serial number, this can be skipped.

```bash
$ pbyk -l
Name: Yubico YubiKey OTP+FIDO+CCID; Serial: 15995762
```

Next, reset the YubiKey so that it uses the expected management key.

```bash
$ pbyk -s 15995762 -r
```

The next two steps require Purebred Agent participation. The agent should provide their EDIPI and a 
Pre-enrollment OTPs. Pre-enrollment must be completed within 3 minutes of generating the Pre-enrollment OTP.

```bash
$ pbyk -s 15995762 -a 5533442211 -1 74517780
Enter PIN: 
Pre-enroll completed successfully: 07E7730D014D55AFA800609C962E9FF40B61A5AD70E07AAC95E9F6911C4B48E1
```

Next, the Purebred Agent will affirm the hash value to establish trust in the device and will provide an Enrollment OTP.
As with Pre-enrollment, the Enrollment operation must be completed within three minutes of generating the Enrollment OTP.

```bash
$ pbyk -s 15995762 -a 5533442211 -2 63999319
Enter PIN: 
Enroll completed successfully
```
Provisioning user keys does not require Purebred Agent co-operation but does requre a UKM OTP. Browse to the My Devices
tab on the Purebred portal to obtain a UKM OTP for your device and enter it as shown below.

```bash
$ pbyk -s 15995762 -3 38979363
Enter PIN: 
UKM completed successfully
```
The Recover operation is optional and follows the same steps as described for UKM. After obtaining a UKM OTP complete
the Recover operation as shown below,

```bash
$ pbyk -s 15995762 -4 30468894
Enter PIN: 
Recover completed successfully
```

## Status

tl;dr: not ready to use.

This is a work-in-progress implementation which is at an early stage of
development.

## Minimum Supported Rust Version

This crate was developed using **Rust 1.70**.

## License

Licensed under either of:

- [Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0)
- [MIT license](http://opensource.org/licenses/MIT)

at your option.

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall be
dual licensed as above, without any additional terms or conditions.
