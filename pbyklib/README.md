# pbyklib

The `pbyklib` library provides a (nearly) pure Rust implementation of the protocol required to enroll YubiKeys with a
Purebred instance. Purebred is a derived credential issuance system used by the U.S. Department of Defense. This library
is not an official release and is not affiliated with the Defense Information Systems Agency. All testing has been done
using non-production systems.

As with official Purebred apps, enrollment requires the participation of a Purebred Agent. Specifically, when enrolling
the device, you will need a Purebred Agent's EDIPI and a pair of one-time password values generated by that agent and
provided in a timely manner. When provisioning user certificates to the device, user key management (UKM) one-time
passwords (OTPs) are required. These can be obtained by authenticating to the target Purebred instance using the
(simulated) CAC credentials from which dervied credentials will be created.

## Workflow

The workflow consists of four steps, with an optional fifth step that can be used to recover addition escrowed keys.

- [Reset](reset_yubikey::reset_yubikey)
- [Pre-enroll](pre_enroll::pre_enroll)
- [Enroll](enroll::enroll)
- [User key management](ukm::ukm)
- (Optional) [Recover](recover::recover)

## Protocol

The protocol is essentially Apple's [Over-the-Air Profile Delivery and Configuration (OTA protocol)](https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/OTASecurity/OTASecurity.html)
with the following three alterations:

- An additional round-trip is added before the OTA protocol is executed to provide the portal with a self-signed certificate corresponding to a freshly generated key pair. This additional step is referred to as Pre-enrollment or Phase 0 and is used to establish trust in a public key.
- The Phase 2 response during OTA execution is encrypted using the certificate presented to the portal and verified by a Purebred Agent during Pre-enrollment.
- One or more user key management (UKM) or recover steps may be performed to deliver encrypted configuration protocols following execution of the OTA protocol.

## Status

tl;dr: not ready to use.

This is a work-in-progress implementation which is at an early stage of
development.

## Minimum Supported Rust Version

This crate was developed using **Rust 1.70**.

## License

Licensed under either of:

- [Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0)
- [MIT license](http://opensource.org/licenses/MIT)

at your option.

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall be
dual licensed as above, without any additional terms or conditions.
